<template>
    <a-layout-content :style="{
        background: '#fff',
        padding: '24px',
        margin: 0,
        minHeight: '800px',
    }">
        <div class="opBar" v-if="stage !== 'dashboard'">
            <label class="search_label">时间范围</label>
            <a-range-picker style="width: 400px" show-time :format="dateTimeFormat" :presets="rangePresets"
                v-model:value="dateTimeRange" @change="onRangeChange" size="small" />
        </div>
        <div>
            <a-table :data-source="alarmData" :columns="columns" size="small" :row-selection="rowSelection"
                :pagination="pgSetting" @change="onChange">
                <template #bodyCell="{ text, column, record }">
                    <template v-if="column.key === 'linux'">
                        {{ record.linux.hostname }}
                    </template>
                    <template v-else-if="column.key === 'msg'">
                        <a @click="showAlarmDetail(record)">
                            {{ record.msg }}
                        </a>
                    </template>
                    <template v-else-if="column.key === 'timestamp'">
                        {{ dayjs(record.timestamp).format("YYYY/MM/DD HH:mm:ss") }}
                    </template>
                    <template v-else-if="column.key === 'createTimestamp'">
                        {{ dayjs(record.createTimestamp).format("YYYY/MM/DD HH:mm:ss") }}
                    </template>
                    <template v-else-if="column.key === 'ack'">
                        <span v-if="record.ack === true" style="font-weight: bold;color: green;">
                            <a-tag color="green">已恢复</a-tag>
                        </span>
                        <span v-else style="font-weight: bold;;color: red;">
                            <a-popconfirm title="您正在手动关闭一个告警，是否确认？" ok-text="确认" cancel-text="取消"
                                @confirm="disableAlarm(record.id)">
                                <a-tag color="red">生效中</a-tag>
                            </a-popconfirm>
                        </span>
                    </template>
                </template>
            </a-table>
        </div>
    </a-layout-content>
    <a-modal v-model:open="isShowDetail" title="消息详情" @ok="isShowDetail = false" width="1000px">
        <a-descriptions bordered :column="2">
            <a-descriptions-item label="消息" :span="2">
                <span style="">{{ alarm?.msg }}</span>
            </a-descriptions-item>
            <a-descriptions-item label="Trigger ID">{{ alarm?.triggerId }}</a-descriptions-item>
            <a-descriptions-item label="Trigger">{{ alarm?.trigger }}</a-descriptions-item>
            <a-descriptions-item label="消息时间">
                {{ dayjs(alarm?.timestamp).format("YYYY/MM/DD HH:mm:ss") }}</a-descriptions-item>
            <a-descriptions-item label="记录时间">{{ dayjs(alarm?.createTimestamp).format("YYYY/MM/DD HH:mm:ss")
                }}</a-descriptions-item>
            <a-descriptions-item label="产生对象">{{ alarm?.linux?.hostname }}</a-descriptions-item>
            <a-descriptions-item label="消息状态">
                <span v-if="alarm?.ack === true" style="font-weight: bold;color: green;">
                    <a-tag color="green">已恢复</a-tag>
                </span>
                <span v-else style="font-weight: bold;;color: red;">
                    <a-tag color="red">生效中</a-tag>
                </span>
            </a-descriptions-item>
            <!-- <a-descriptions-item label="" :span="2">
                <span style="">{{ alarm?.msg }}</span>
            </a-descriptions-item> -->
        </a-descriptions>
    </a-modal>
</template>
<script lang="ts" setup>
import { computed, onMounted, reactive, defineProps, ref } from 'vue';
import { Alarm } from '.';
import dayjs from 'dayjs';
import { Linux } from '../linux/api';

const props = defineProps({
    stage: String
})

const pagination = reactive({
    page: 0,
    pageSize: props["stage"] == "dashboard" ? 200 : 20,
    total: 0,
})

const isShowDetail = ref(false)

const disableAlarm = (alarmId: number) => {
    new Alarm(alarmId).disable().then(() => {
        loadPage()
    })
}

const pgSetting = computed(() => ({
    total: pagination.total,
    current: pagination.page + 1,
    pageSize: pagination.pageSize,
    showQuickJumper: true,
    showSizeChanger: true,
    showTotal: (total: number, range: number) => {
        return range + ", 共" + total;
    },
}));

const alarmData = ref([])
const alarm = ref<Alarm>()

const columns = [
    {
        title: "消息时间",
        dataIndex: "timestamp",
        key: "timestamp",
        width: 160
    }, {
        title: "产生对象",
        dataIndex: "linux",
        key: "linux",
        width: 160
    }, {
        title: "消息",
        dataIndex: "msg",
        key: "msg",
    }, {
        title: "消息状态",
        dataIndex: "ack",
        key: "ack",
        width: 100
    }
]

const showAlarmDetail = (record: any) => {
    const a = new Alarm(record['id'])
    a.load().then(resp => {
        const data = resp["data"]
        a.ack = data['ack']
        a.timestamp = data['timestamp']
        a.createTimestamp = data['createTimestamp']
        a.linux = new Linux(data["linux"]["id"], data["linux"]["hostname"])
        a.trigger = data['trigger']
        a.triggerId = data['triggerId']
        a.perfData = data['perfData']
        a.msg = data["msg"]
        isShowDetail.value = true
    })
    alarm.value = a
}

const loadPage = () => {
    Alarm.loadPage(pagination).then((resp) => {
        alarmData.value = resp["data"]["lst"];
        pagination.total = resp["data"]["total"];
    })
}

onMounted(() => {
    loadPage()
})
</script>
<style lang="css" scoped>
.opBar {
    display: flex;
    margin-bottom: 1rem;
    width: 25%;
    justify-content: space-between;
}

.op-item {
    margin-right: 1rem;
}

.search_label {
    width: 5rem;
    font-weight: bold;
}
</style>